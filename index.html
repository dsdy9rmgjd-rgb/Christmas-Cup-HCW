<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>HCW U10 Maedels Weihnachtsfeier ‚Äì Turnier-App (online)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #020617;
      --card-bg: #020617;
      --accent: #1d4ed8;
      --accent-soft: rgba(37,99,235,0.15);
      --accent-2: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: rgba(148,163,184,0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e3a8a 0, #020617 55%, #000 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
    }
    body, input, textarea, button { -webkit-font-smoothing: antialiased; }
    .app-shell {
      width: 100%;
      max-width: 1024px;
      padding: 0.75rem 0.75rem 1rem;
    }
    header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.6rem;
    }
    .logo-wrap {
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #60a5fa, #020617 70%);
      padding: 3px;
      flex-shrink: 0;
    }
    .logo-inner {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .logo-inner img {
      max-width: 120%;
      height: auto;
    }
    .title-block h1 {
      font-size: 1.05rem;
      margin: 0 0 0.15rem;
      letter-spacing: 0.02em;
    }
    .title-block p {
      margin: 0;
      font-size: 0.78rem;
      color: var(--muted);
    }
    .title-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 0.68rem;
      margin-top: 0.25rem;
      background: rgba(15,23,42,0.9);
    }
    .title-pill span { font-size: 0.85rem; }
    nav.tabs {
      display: flex;
      gap: 0.4rem;
      margin: 0.3rem 0 0.7rem;
    }
    .tab-btn {
      flex: 1;
      padding: 0.25rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(30,64,175,0.9);
      background: rgba(15,23,42,0.95);
      color: var(--muted);
      font-size: 0.78rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      cursor: pointer;
    }
    .tab-btn.active {
      border-color: var(--accent);
      background: rgba(37,99,235,0.3);
      color: #e0f2fe;
    }
    main {
      display: grid;
      grid-template-columns: minmax(0, 1.35fr) minmax(0, 1.1fr);
      gap: 0.75rem;
    }
    @media (max-width: 900px) {
      main { grid-template-columns: minmax(0,1fr); }
      .app-shell { padding-inline: 0.6rem; }
    }
    .card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      border-radius: 16px;
      padding: 0.75rem 0.8rem 0.85rem;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(15,23,42,0.75), 0 0 0 1px rgba(15,23,42,0.8);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      margin-bottom: 0.6rem;
    }
    .card h2 {
      font-size: 0.9rem;
      margin: 0 0 0.35rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .card h2 span.emoji { font-size: 1.05rem; }
    .hint {
      font-size: 0.72rem;
      color: var(--muted);
      margin-bottom: 0.45rem;
    }
    .teams-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.55rem;
    }
    @media (max-width: 640px) {
      .teams-grid { grid-template-columns: minmax(0,1fr); }
    }
    .team-box {
      border-radius: 12px;
      padding: 0.55rem 0.6rem;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95), rgba(15,23,42,1));
      border: 1px solid rgba(30,64,175,0.7);
    }
    .team-box h3 {
      font-size: 0.86rem;
      margin: 0 0 0.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.35rem;
    }
    .team-id {
      font-size: 0.68rem;
      color: var(--muted);
    }
    .emoji-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      background: var(--accent-soft);
    }
    .team-name-input {
      width: 100%;
      box-sizing: border-box;
      padding: 0.25rem 0.35rem;
      font-size: 0.78rem;
      margin-bottom: 0.22rem;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text);
    }
    .team-name-input:focus,
    .players-textarea:focus {
      outline: 1px solid var(--accent);
      border-color: var(--accent);
    }
    .players-label {
      font-size: 0.68rem;
      color: var(--muted);
      display: block;
      margin-bottom: 0.1rem;
    }
    .players-textarea {
      width: 100%;
      box-sizing: border-box;
      min-height: 3.2rem;
      font-size: 0.74rem;
      padding: 0.22rem 0.35rem;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      resize: vertical;
    }
    .readonly { opacity: 0.6; cursor: not-allowed; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.74rem;
      table-layout: fixed;
    }
    th, td {
      border-bottom: 1px solid rgba(30,64,175,0.6);
      padding: 0.25rem 0.25rem;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    th {
      background: rgba(15,23,42,0.98);
      font-weight: 600;
      font-size: 0.7rem;
      color: #dbeafe;
    }
    td.team-cell { text-align: left; }
    .phase-header {
      background: rgba(37,99,235,0.2);
      border-radius: 999px;
      padding: 0.1rem 0.55rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      margin-bottom: 0.3rem;
      font-size: 0.7rem;
    }
    .phase-header span.icon { font-size: 0.9rem; }
    .score-input {
      width: 2.4rem;
      text-align: center;
      padding: 0.12rem;
      font-size: 0.74rem;
      border-radius: 6px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.98);
      color: var(--text);
    }
    .score-input:focus {
      outline: 1px solid var(--accent-2);
      border-color: var(--accent-2);
    }
    .schedule-table th:nth-child(1) { width: 2.2rem; }
    .schedule-table th:nth-child(2) { width: 4.2rem; }
    .schedule-table th:nth-child(3) { width: 4rem; }
    .schedule-table th:nth-child(4) { width: 23%; }
    .schedule-table th:nth-child(5) { width: 1.8rem; }
    .schedule-table th:nth-child(6) { width: 23%; }
    .schedule-table th:nth-child(7),
    .schedule-table th:nth-child(8) { width: 2.5rem; }
    .schedule-table td.team-name,
    .schedule-table td.team-name-away { max-width: none; }
    .schedule-table td.vs-cell {
      text-align: center;
      color: var(--muted);
    }
    .field-cell {
      text-align: center;
      font-size: 0.72rem;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      background: rgba(34,197,94,0.18);
      border: 1px solid rgba(22,163,74,0.7);
      font-size: 0.68rem;
      color: #bbf7d0;
      margin-top: 0.3rem;
    }
    .chip span { font-size: 0.85rem; }
    .footer-note {
      margin-top: 0.45rem;
      font-size: 0.7rem;
      color: var(--muted);
    }
    .photo-grid {
      margin-top: 0.45rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .photo-item {
      border-radius: 10px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(30,64,175,0.8);
      padding: 0.3rem;
      max-width: 130px;
      position: relative;
    }
    .photo-item img {
      max-width: 100%;
      display: block;
      border-radius: 6px;
    }
    .photo-item a {
      display: block;
      font-size: 0.66rem;
      text-align: center;
      margin-top: 0.12rem;
      text-decoration: none;
      color: #60a5fa;
    }
    .photo-item a:hover { text-decoration: underline; }
    .photo-delete-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      border-radius: 999px;
      border: none;
      background: rgba(239,68,68,0.92);
      color: #fee2e2;
      font-size: 0.65rem;
      padding: 0.12rem 0.3rem;
      cursor: pointer;
    }
    .photo-delete-btn:hover { background: rgba(239,68,68,1); }
    input[type="file"] {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 0.35rem;
    }
    .supabase-note {
      font-size: 0.68rem;
      color: var(--muted);
      margin-top: 0.4rem;
    }
    .supabase-note code {
      background: rgba(15,23,42,0.96);
      padding: 0.05rem 0.25rem;
      border-radius: 4px;
      font-size: 0.67rem;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.68rem;
      border: 1px solid rgba(148,163,184,0.6);
      color: var(--muted);
      background: rgba(15,23,42,0.9);
    }
    .status-pill.online {
      border-color: rgba(34,197,94,0.7);
      color: #bbf7d0;
      background: rgba(22,163,74,0.2);
    }
    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #64748b;
    }
    .status-pill.online .status-dot { background: #22c55e; }
    .trainer-controls {
      margin-top: 0.25rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      align-items: center;
      font-size: 0.72rem;
    }
    .mode-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.12rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: var(--muted);
    }
    .mode-pill.trainer {
      border-color: rgba(34,197,94,0.7);
      background: rgba(22,163,74,0.18);
      color: #bbf7d0;
    }
    .mode-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #64748b;
    }
    .mode-pill.trainer .mode-dot { background: #22c55e; }
    .trainer-btn {
      border-radius: 999px;
      border: 1px solid rgba(37,99,235,0.9);
      background: rgba(15,23,42,0.95);
      color: #bfdbfe;
      font-size: 0.72rem;
      padding: 0.15rem 0.65rem;
      cursor: pointer;
    }
    .trainer-btn:hover { background: rgba(37,99,235,0.35); }
    .page { display: none; }
    .page.active { display: block; }

    .scorer-name-input {
      width: 100%;
      padding: 0.22rem 0.35rem;
      font-size: 0.74rem;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text);
    }
    .scorer-goals-input {
      width: 3rem;
      padding: 0.22rem 0.35rem;
      font-size: 0.74rem;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      text-align: center;
    }
    .scorer-name-input:focus,
    .scorer-goals-input:focus {
      outline: 1px solid var(--accent-2);
      border-color: var(--accent-2);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="logo-wrap">
        <div class="logo-inner">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cc/HC_Wacker_M%C3%BCnchen_logo.svg/2032px-HC_Wacker_M%C3%BCnchen_logo.svg.png"
               alt="HC Wacker Muenchen Logo" />
        </div>
      </div>
      <div class="title-block">
        <h1>HCW U10 Maedels Weihnachtsfeier</h1>
        <p>Hallenfussball ‚Ä¢ 8 Teams ‚Ä¢ Live-Spielplan &amp; Fotos</p>
        <div style="display:flex; gap:0.4rem; margin-top:0.25rem; flex-wrap:wrap;">
          <div class="title-pill">
            <span>üéÑ</span>
            <span>Turnier-App im HCW-Design</span>
          </div>
          <div id="supabaseStatus" class="status-pill">
            <span class="status-dot"></span>
            <span>Supabase-Status wird ermittelt ...</span>
          </div>
        </div>
        <div class="trainer-controls">
          <div id="modePill" class="mode-pill">
            <span class="mode-dot"></span>
            <span id="modeLabel">Modus: Zuschauer (nur lesen)</span>
          </div>
          <button id="loginBtn" class="trainer-btn">Trainer-Login</button>
          <button id="logoutBtn" class="trainer-btn" style="display:none;">Logout</button>
        </div>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-page="turnier">
        <span>‚öΩ</span>
        <span>Turnier</span>
      </button>
      <button class="tab-btn" data-page="fotos">
        <span>üì∏</span>
        <span>Fotos</span>
      </button>
    </nav>

    <div id="page-turnier" class="page active">
      <main>
        <div>
          <div class="card">
            <h2><span class="emoji">üêæ</span> Teams &amp; Mitspielerinnen</h2>
            <div class="hint">
              Aenderungen sind nur im <strong>Trainer-Modus</strong> moeglich (Passwort: "unknown").
              Daten werden in Supabase gespeichert und lokal im Browser zwischengespeichert.
            </div>
            <div class="teams-grid" id="teamsContainer"></div>
          </div>

          <div class="card">
            <h2><span class="emoji">üìã</span> Spielplan &amp; Ergebnisse</h2>
            <div class="hint">
              Ergebnisse eintragen ‚Äì Gruppentabellen, Halbfinale &amp; Platzierungsspiele aktualisieren sich automatisch.
              Bearbeitung ebenfalls nur im Trainer-Modus.
            </div>
            <div id="scheduleContainer"></div>
          </div>
        </div>

        <div>
          <div class="card">
            <h2><span class="emoji">üìä</span> Gruppentabellen</h2>
            <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:0.6rem;">
              <div>
                <div class="phase-header">
                  <span class="icon">üÖ∞Ô∏è</span>
                  <span>Gruppe A</span>
                </div>
                <table id="tableGroupA">
                  <colgroup>
                    <col style="width: 7%;">
                    <col style="width: 53%;">
                    <col style="width: 7%;">
                    <col style="width: 7%;">
                    <col style="width: 7%;">
                    <col style="width: 7%;">
                    <col style="width: 6%;">
                    <col style="width: 6%;">
                    <col style="width: 6%;">
                  </colgroup>
                  <thead>
                    <tr>
                      <th>Pl.</th>
                      <th>Team</th>
                      <th>Sp.</th>
                      <th>S</th>
                      <th>U</th>
                      <th>N</th>
                      <th>Tore</th>
                      <th>Diff</th>
                      <th>Pkt</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div>
                <div class="phase-header">
                  <span class="icon">üÖ±Ô∏è</span>
                  <span>Gruppe B</span>
                </div>
                <table id="tableGroupB">
                  <colgroup>
                    <col style="width: 7%;">
                    <col style="width: 53%;">
                    <col style="width: 7%;">
                    <col style="width: 7%;">
                    <col style="width: 7%;">
                    <col style="width: 7%;">
                    <col style="width: 6%;">
                    <col style="width: 6%;">
                    <col style="width: 6%;">
                  </colgroup>
                  <thead>
                    <tr>
                      <th>Pl.</th>
                      <th>Team</th>
                      <th>Sp.</th>
                      <th>S</th>
                      <th>U</th>
                      <th>N</th>
                      <th>Tore</th>
                      <th>Diff</th>
                      <th>Pkt</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div class="footer-note">
              Wertung: Sieg = 3 Punkte, Unentschieden = 1 Punkt, Niederlage = 0 Punkte.
              Sortierung: Punkte -> Tordifferenz -> erzielte Tore -> Name.
            </div>
          </div>

          <div class="card">
            <h2><span class="emoji">üèÜ</span> K.O.-Spiele &amp; Platzierungen</h2>
            <div id="koInfo" class="hint"></div>
            <div class="chip">
              <span>‚ú®</span>
              <span>Finale ist das letzte Spiel des Turniers</span>
            </div>
          </div>

          <div class="card">
            <h2><span class="emoji">ü•Ö</span> Torschuetzenkoenigin</h2>
            <div class="hint">
              Trage hier bis zu 40 Spielerinnen und ihre Tore ein. Die Liste sortiert sich automatisch nach den meisten Toren (nur Trainer-Modus editierbar).
            </div>
            <table id="scorerTable">
              <thead>
                <tr>
                  <th>Platz</th>
                  <th>Name</th>
                  <th>Tore</th>
                </tr>
              </thead>
              <tbody id="scorerTableBody"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <div id="page-fotos" class="page">
      <div class="card">
        <h2><span class="emoji">üì∏</span> Foto-Galerie (Supabase Storage)</h2>
        <div class="hint">
          Fotos duerfen <strong>alle hochladen</strong>. Loeschen ist nur im Trainer-Modus moeglich.
        </div>
        <input type="file" id="photoInput" accept="image/*" multiple />
        <div class="hint" style="margin-top:0.3rem;">
          Hinweis: Bucket <code>photos</code> (Public) und Ordner <code>hcw-u10</code> muessen in Supabase existieren.
        </div>
        <div id="photoGallery" class="photo-grid"></div>
        <div class="supabase-note">
          <strong>Supabase-Konfiguration:</strong><br>
          - Tabelle <code>turnier_state</code> (id TEXT PK, data JSONB) fuer Turnierdaten<br>
          - Bucket <code>photos</code> (Public) + Ordner <code>hcw-u10</code> fuer Bilder
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Supabase Setup ---------- */
    var SUPABASE_URL = "https://pskdnrvvjfkbzyyriuhv.supabase.co";
    var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza2RucnZ2amZrYnp5eXJpdWh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMjg3NTgsImV4cCI6MjA4MDgwNDc1OH0.4OhhNTvOjYqqGVp7xtB1nDA-9XWoWpuQneELTsOKmgQ";
    var TURNIER_STATE_ID = "hcw-u10";
    var supabaseClient = null;
    try {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (e) {
      console.warn("Supabase konnte nicht initialisiert werden:", e);
    }

    var supabaseStatusEl = document.getElementById("supabaseStatus");
    function setSupabaseStatus(online, text) {
      if (!supabaseStatusEl) return;
      if (online) {
        supabaseStatusEl.classList.add("online");
      } else {
        supabaseStatusEl.classList.remove("online");
      }
      var spanText = supabaseStatusEl.querySelector("span:nth-child(2)");
      if (spanText) spanText.textContent = text;
    }
    if (!supabaseClient) {
      setSupabaseStatus(false, "Supabase nicht verfuegbar ‚Äì nur lokale Speicherung");
    } else {
      setSupabaseStatus(false, "Verbunden ‚Äì lade Daten ...");
    }

    /* ---------- Turnier-Struktur ---------- */
    var TRAINER_PASSWORD = "HCW";
    var TRAINER_MODE_KEY = "hcw_trainer_mode";
    var isTrainer = false;

    var defaultTeams = [
      { id: 0, group: 'A', name: 'Loewen',    players: '' },
      { id: 1, group: 'A', name: 'Baeren',    players: '' },
      { id: 2, group: 'A', name: 'Tiger',     players: '' },
      { id: 3, group: 'A', name: 'Panther',   players: '' },
      { id: 4, group: 'B', name: 'Delphin',   players: '' },
      { id: 5, group: 'B', name: 'Haifisch',  players: '' },
      { id: 6, group: 'B', name: 'Kugelfisch',players: '' },
      { id: 7, group: 'B', name: 'Oktopus',   players: '' }
    ];
    var teamIcons = {
      0: 'ü¶Å', 1: 'üêª', 2: 'üêØ', 3: 'üêÜ',
      4: 'üê¨', 5: 'ü¶à', 6: 'üê°', 7: 'üêô'
    };

    // Gruppenphase: 6 Runden, je Runde A auf Platz 1, B auf Platz 2
    var groupMatches = [
      { id: 'GA1', phase: 'groupA', round: 1, field: 1, home: 0, away: 1 },
      { id: 'GB1', phase: 'groupB', round: 1, field: 2, home: 4, away: 5 },
      { id: 'GA2', phase: 'groupA', round: 2, field: 1, home: 2, away: 3 },
      { id: 'GB2', phase: 'groupB', round: 2, field: 2, home: 6, away: 7 },
      { id: 'GA3', phase: 'groupA', round: 3, field: 1, home: 0, away: 2 },
      { id: 'GB3', phase: 'groupB', round: 3, field: 2, home: 4, away: 6 },
      { id: 'GA4', phase: 'groupA', round: 4, field: 1, home: 1, away: 3 },
      { id: 'GB4', phase: 'groupB', round: 4, field: 2, home: 5, away: 7 },
      { id: 'GA5', phase: 'groupA', round: 5, field: 1, home: 0, away: 3 },
      { id: 'GB5', phase: 'groupB', round: 5, field: 2, home: 4, away: 7 },
      { id: 'GA6', phase: 'groupA', round: 6, field: 1, home: 1, away: 2 },
      { id: 'GB6', phase: 'groupB', round: 6, field: 2, home: 5, away: 6 }
    ];

    var koMatches = [
      {
        id: 'HF1', phase: 'HF', label: 'Halbfinale 1 (1A ‚Äì 2B)', field: 1,
        homeRef: { type: 'groupPos', group: 'A', pos: 1 },
        awayRef: { type: 'groupPos', group: 'B', pos: 2 }
      },
      {
        id: 'HF2', phase: 'HF', label: 'Halbfinale 2 (1B ‚Äì 2A)', field: 2,
        homeRef: { type: 'groupPos', group: 'B', pos: 1 },
        awayRef: { type: 'groupPos', group: 'A', pos: 2 }
      },
      {
        id: 'P7', phase: 'P', label: 'Spiel um Platz 7 (4A ‚Äì 4B)', field: 1,
        homeRef: { type: 'groupPos', group: 'A', pos: 4 },
        awayRef: { type: 'groupPos', group: 'B', pos: 4 }
      },
      {
        id: 'P5', phase: 'P', label: 'Spiel um Platz 5 (3A ‚Äì 3B)', field: 2,
        homeRef: { type: 'groupPos', group: 'A', pos: 3 },
        awayRef: { type: 'groupPos', group: 'B', pos: 3 }
      },
      {
        id: 'P3', phase: 'P', label: 'Spiel um Platz 3 (Verlierer HF1 ‚Äì Verlierer HF2)', field: 1,
        homeRef: { type: 'loser', matchId: 'HF1' },
        awayRef: { type: 'loser', matchId: 'HF2' }
      },
      {
        id: 'F', phase: 'F', label: 'Finale (Sieger HF1 ‚Äì Sieger HF2)', field: 2,
        homeRef: { type: 'winner', matchId: 'HF1' },
        awayRef: { type: 'winner', matchId: 'HF2' }
      }
    ];

    var defaultScorers = [];
    for (var si = 0; si < 40; si++) {
      defaultScorers.push({ id: si, name: '', goals: 0 });
    }

    var teams = JSON.parse(JSON.stringify(defaultTeams));
    var scores = {};
    var scorers = JSON.parse(JSON.stringify(defaultScorers));

    var LOCAL_STORAGE_KEY = "hcw_u10_turnier_state_v3";

    function loadFromLocal() {
      try {
        var raw = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!raw) return;
        var state = JSON.parse(raw);
        if (state.teams) teams = state.teams;
        if (state.scores) scores = state.scores;
        if (state.scorers) scorers = state.scorers;
      } catch (e) {
        console.warn("Lokaler State konnte nicht geladen werden:", e);
      }
    }

    function saveToLocal() {
      try {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
          teams: teams,
          scores: scores,
          scorers: scorers
        }));
      } catch (e) {
        console.warn("Lokaler State konnte nicht gespeichert werden:", e);
      }
    }

    function getScore(matchId) {
      return scores[matchId] || { home: '', away: '' };
    }

    function setScore(matchId, side, value) {
      if (!isTrainer) return;
      var parsed = value === '' ? '' : Math.max(0, parseInt(value, 10) || 0);
      if (!scores[matchId]) scores[matchId] = { home: '', away: '' };
      scores[matchId][side] = parsed;
      saveToLocal();
      scheduleSupabaseSave();
      recomputeAndRender();
    }

    function computeGroupStats(group) {
      var teamIds = [];
      for (var i = 0; i < teams.length; i++) {
        if (teams[i].group === group) teamIds.push(teams[i].id);
      }
      var stats = {};
      for (i = 0; i < teamIds.length; i++) {
        var id = teamIds[i];
        stats[id] = {
          teamId: id,
          played: 0, wins: 0, draws: 0, losses: 0,
          gf: 0, ga: 0, pts: 0, diff: 0
        };
      }

      for (i = 0; i < groupMatches.length; i++) {
        var m = groupMatches[i];
        var tHome = teams[m.home];
        var tAway = teams[m.away];
        if (tHome.group !== group && tAway.group !== group) continue;
        var s = scores[m.id];
        if (!s || s.home === '' || s.away === '') continue;

        var h = parseInt(s.home, 10);
        var a = parseInt(s.away, 10);

        stats[m.home].played++;
        stats[m.away].played++;
        stats[m.home].gf += h;
        stats[m.home].ga += a;
        stats[m.away].gf += a;
        stats[m.away].ga += h;

        if (h > a) {
          stats[m.home].wins++; stats[m.home].pts += 3;
          stats[m.away].losses++;
        } else if (h < a) {
          stats[m.away].wins++; stats[m.away].pts += 3;
          stats[m.home].losses++;
        } else {
          stats[m.home].draws++; stats[m.home].pts += 1;
          stats[m.away].draws++; stats[m.away].pts += 1;
        }
      }

      var list = [];
      for (var key in stats) {
        if (stats.hasOwnProperty(key)) {
          var row = stats[key];
          row.diff = row.gf - row.ga;
          list.push(row);
        }
      }

      list.sort(function (a, b) {
        if (b.pts !== a.pts) return b.pts - a.pts;
        if (b.diff !== a.diff) return b.diff - a.diff;
        if (b.gf !== a.gf) return b.gf - a.gf;
        var nameA = teams[a.teamId].name.toLowerCase();
        var nameB = teams[b.teamId].name.toLowerCase();
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;
        return 0;
      });
      return list;
    }

    function resolveRefToTeamIndex(ref, groupTables, koResults) {
      if (!ref) return null;
      if (ref.type === 'groupPos') {
        var table = groupTables[ref.group];
        if (!table || table.length < ref.pos) return null;
        return table[ref.pos - 1].teamId;
      }
      if (ref.type === 'winner' || ref.type === 'loser') {
        var match = koResults[ref.matchId];
        if (!match || match.homeTeam == null || match.awayTeam == null) return null;
        if (match.score_home == null || match.score_away == null) return null;
        if (match.score_home === match.score_away) return null;
        var homeWon = match.score_home > match.score_away;
        if (ref.type === 'winner') {
          return homeWon ? match.homeTeam : match.awayTeam;
        } else {
          return homeWon ? match.awayTeam : match.homeTeam;
        }
      }
      return null;
    }

    function renderTeams() {
      var container = document.getElementById('teamsContainer');
      container.innerHTML = '';
      for (var i = 0; i < teams.length; i++) {
        (function (team) {
          var box = document.createElement('div');
          box.className = 'team-box';

          var h3 = document.createElement('h3');
          var left = document.createElement('div');
          left.style.display = 'flex';
          left.style.alignItems = 'center';
          left.style.gap = '0.3rem';

          var iconSpan = document.createElement('span');
          iconSpan.className = 'emoji-icon';
          iconSpan.textContent = teamIcons[team.id] || '‚öΩ';

          var nameLabel = document.createElement('span');
          nameLabel.textContent = team.name;

          left.appendChild(iconSpan);
          left.appendChild(nameLabel);

          var idSpan = document.createElement('span');
          idSpan.className = 'team-id';
          idSpan.textContent = 'Gruppe ' + team.group;

          h3.appendChild(left);
          h3.appendChild(idSpan);
          box.appendChild(h3);

          var nameInput = document.createElement('input');
          nameInput.className = 'team-name-input';
          nameInput.value = team.name;
          nameInput.addEventListener('input', function () {
            if (!isTrainer) {
              nameInput.value = team.name;
              return;
            }
            team.name = nameInput.value || '';
            saveToLocal();
            scheduleSupabaseSave();
            recomputeAndRender();
          });
          box.appendChild(nameInput);

          var label = document.createElement('span');
          label.className = 'players-label';
          label.textContent = 'Mitspielerinnen:';
          box.appendChild(label);

          var ta = document.createElement('textarea');
          ta.className = 'players-textarea';
          ta.value = team.players || '';
          ta.addEventListener('input', function () {
            if (!isTrainer) {
              ta.value = team.players || '';
              return;
            }
            team.players = ta.value;
            saveToLocal();
            scheduleSupabaseSave();
          });
          box.appendChild(ta);

          container.appendChild(box);
        })(teams[i]);
      }
      updateEditability();
    }

    function renderGroupTable(group, tableId, tableData) {
      var tbody = document.querySelector('#' + tableId + ' tbody');
      tbody.innerHTML = '';
      for (var i = 0; i < tableData.length; i++) {
        var row = tableData[i];
        var tr = document.createElement('tr');
        var t = teams[row.teamId];
        var icon = teamIcons[row.teamId] || '‚öΩ';
        var cols = [
          (i + 1),
          icon + ' ' + t.name,
          row.played,
          row.wins,
          row.draws,
          row.losses,
          row.gf + ':' + row.ga,
          row.diff,
          row.pts
        ];
        for (var c = 0; c < cols.length; c++) {
          var td = document.createElement('td');
          if (c === 1) td.className = 'team-cell';
          td.textContent = cols[c];
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    function renderSchedule(groupTables, koResults) {
      var container = document.getElementById('scheduleContainer');
      container.innerHTML = '';

      var table = document.createElement('table');
      table.className = 'schedule-table';

      var thead = document.createElement('thead');
      thead.innerHTML = '<tr>' +
        '<th>Nr.</th>' +
        '<th>Phase</th>' +
        '<th>Platz</th>' +
        '<th>Heim</th>' +
        '<th></th>' +
        '<th>Gast</th>' +
        '<th>H</th>' +
        '<th>A</th>' +
        '</tr>';
      table.appendChild(thead);

      var tbody = document.createElement('tbody');
      var spielNr = 1;

      function addMatchRow(label, matchId, field, homeIdx, awayIdx, placeholderHome, placeholderAway) {
        var tr = document.createElement('tr');

        var nrCell = document.createElement('td');
        nrCell.textContent = spielNr++;
        tr.appendChild(nrCell);

        var phaseCell = document.createElement('td');
        phaseCell.textContent = label;
        tr.appendChild(phaseCell);

        var fieldCell = document.createElement('td');
        fieldCell.className = 'field-cell';
        fieldCell.textContent = field ? ('Platz ' + field) : '‚Äì';
        tr.appendChild(fieldCell);

        var homeCell = document.createElement('td');
        homeCell.className = 'team-name';
        if (homeIdx != null) {
          homeCell.textContent = (teamIcons[homeIdx] || '‚öΩ') + ' ' + teams[homeIdx].name;
        } else {
          homeCell.textContent = placeholderHome || '‚Äì';
        }
        tr.appendChild(homeCell);

        var vsCell = document.createElement('td');
        vsCell.className = 'vs-cell';
        vsCell.textContent = '‚Äì';
        tr.appendChild(vsCell);

        var awayCell = document.createElement('td');
        awayCell.className = 'team-name-away';
        if (awayIdx != null) {
          awayCell.textContent = (teamIcons[awayIdx] || '‚öΩ') + ' ' + teams[awayIdx].name;
        } else {
          awayCell.textContent = placeholderAway || '‚Äì';
        }
        tr.appendChild(awayCell);

        var scoreHCell = document.createElement('td');
        var scoreACell = document.createElement('td');

        var s = getScore(matchId);
        var inpH = document.createElement('input');
        inpH.type = 'number';
        inpH.min = '0';
        inpH.className = 'score-input';
        inpH.value = s.home;
        inpH.addEventListener('change', function () {
          setScore(matchId, 'home', inpH.value);
        });

        var inpA = document.createElement('input');
        inpA.type = 'number';
        inpA.min = '0';
        inpA.className = 'score-input';
        inpA.value = s.away;
        inpA.addEventListener('change', function () {
          setScore(matchId, 'away', inpA.value);
        });

        scoreHCell.appendChild(inpH);
        scoreACell.appendChild(inpA);
        tr.appendChild(scoreHCell);
        tr.appendChild(scoreACell);

        tbody.appendChild(tr);
      }

      var groupHeaderRow = document.createElement('tr');
      var gh = document.createElement('td');
      gh.colSpan = 8;
      gh.style.textAlign = 'left';
      gh.style.fontWeight = '600';
      gh.style.background = 'rgba(129,140,248,0.22)';
      gh.textContent = 'Gruppenphase (6 Runden)';
      groupHeaderRow.appendChild(gh);
      tbody.appendChild(groupHeaderRow);

      for (var i = 0; i < groupMatches.length; i++) {
        var m = groupMatches[i];
        var rLabel = 'Rd. ' + m.round + ' (' + (teams[m.home].group === 'A' ? 'Gr. A' : 'Gr. B') + ')';
        addMatchRow(rLabel, m.id, m.field, m.home, m.away, null, null);
      }

      var koHeaderRow = document.createElement('tr');
      var kh = document.createElement('td');
      kh.colSpan = 8;
      kh.style.textAlign = 'left';
      kh.style.fontWeight = '600';
      kh.style.background = 'rgba(59,130,246,0.22)';
      kh.textContent = 'K.O.- & Platzierungsspiele';
      koHeaderRow.appendChild(kh);
      tbody.appendChild(koHeaderRow);

      for (i = 0; i < koMatches.length; i++) {
        var km = koMatches[i];
        var res = koResults[km.id];
        var homeIdx = res.homeTeam;
        var awayIdx = res.awayTeam;
        var phHome = '';
        var phAway = '';
        if (homeIdx == null || awayIdx == null) {
          if (km.homeRef.type === 'groupPos') {
            phHome = km.homeRef.pos + km.homeRef.group;
          } else if (km.homeRef.type === 'winner') {
            phHome = 'Sieger ' + km.homeRef.matchId;
          } else if (km.homeRef.type === 'loser') {
            phHome = 'Verlierer ' + km.homeRef.matchId;
          }
          if (km.awayRef.type === 'groupPos') {
            phAway = km.awayRef.pos + km.awayRef.group;
          } else if (km.awayRef.type === 'winner') {
            phAway = 'Sieger ' + km.awayRef.matchId;
          } else if (km.awayRef.type === 'loser') {
            phAway = 'Verlierer ' + km.awayRef.matchId;
          }
        }
        addMatchRow(km.label, km.id, km.field, homeIdx, awayIdx, phHome, phAway);
      }

      table.appendChild(tbody);
      container.appendChild(table);
      updateEditability();
    }

    function renderKoInfo(groupTables, koResults) {
      var el = document.getElementById('koInfo');
      var a = groupTables.A;
      var b = groupTables.B;
      if (!a.length || !b.length) {
        el.textContent = 'Sobald genuegend Gruppenergebnisse eingetragen sind, erscheinen hier die Platzierungen 1A‚Äì4A & 1B‚Äì4B.';
        return;
      }
      function formatTeam(entry) {
        return teamIcons[entry.teamId] + ' ' + teams[entry.teamId].name +
          ' (' + entry.pts + ' P, Diff ' + entry.diff + ', Tore ' + entry.gf + ':' + entry.ga + ')';
      }
      var html = '';
      if (a.length >= 4 && b.length >= 4) {
        html += '<strong>Gruppe A:</strong><br>';
        for (var i = 0; i < a.length; i++) {
          html += (i+1) + '. ' + formatTeam(a[i]) + '<br>';
        }
        html += '<br><strong>Gruppe B:</strong><br>';
        for (i = 0; i < b.length; i++) {
          html += (i+1) + '. ' + formatTeam(b[i]) + '<br>';
        }
      }
      el.innerHTML = html || 'Noch keine vollstaendige Wertung vorhanden.';
    }

    function renderScorers() {
      var tbody = document.getElementById('scorerTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      var sorted = scorers.slice().sort(function(a, b) {
        if (b.goals !== a.goals) return b.goals - a.goals;
        var na = (a.name || '').toLowerCase();
        var nb = (b.name || '').toLowerCase();
        if (na < nb) return -1;
        if (na > nb) return 1;
        return a.id - b.id;
      });

      for (var i = 0; i < sorted.length; i++) {
        (function (entry, index) {
          var tr = document.createElement('tr');

          var tdPlace = document.createElement('td');
          tdPlace.textContent = (index + 1);
          tr.appendChild(tdPlace);

          var tdName = document.createElement('td');
          var nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.className = 'scorer-name-input';
          nameInput.value = entry.name || '';
          nameInput.setAttribute('data-id', entry.id);
         nameInput.addEventListener('input', function () {
    if (!isTrainer) {
        nameInput.value = entry.name || "";
        return;
    }
            const id = Number(nameInput.dataset.id);
    const scorer = scorers.find(s => s.id === id);
    if (!scorer) return;

    scorer.name = nameInput.value;

    saveToLocal();
    scheduleSupabaseSave();
});
          tdName.appendChild(nameInput);
          tr.appendChild(tdName);

          var tdGoals = document.createElement('td');
          var goalsInput = document.createElement('input');
          goalsInput.type = 'number';
          goalsInput.min = '0';
          goalsInput.className = 'scorer-goals-input';
          goalsInput.value = entry.goals || 0;
          goalsInput.setAttribute('data-id', entry.id);
          goalsInput.addEventListener('change', function () {
            if (!isTrainer) {
              var original = scorers.find(function(s) { return s.id === entry.id; });
               goalsInput.value = entry.goals || 0;
  return;
            }
            var id = parseInt(goalsInput.getAttribute('data-id'), 10);
            var s = scorers.find(function (x) { return x.id === id; });
            var val = goalsInput.value === '' ? 0 : Math.max(0, parseInt(goalsInput.value, 10) || 0);
            if (s) {
              s.goals = val;
              saveToLocal();
              scheduleSupabaseSave();
              renderScorers();
            }
          });
          tdGoals.appendChild(goalsInput);
          tr.appendChild(tdGoals);

          tbody.appendChild(tr);
        })(sorted[i], i);
      }
      updateEditability();
    }

    function recomputeAndRender() {
      var tableA = computeGroupStats('A');
      var tableB = computeGroupStats('B');
      renderGroupTable('A', 'tableGroupA', tableA);
      renderGroupTable('B', 'tableGroupB', tableB);

      var groupTables = { A: tableA, B: tableB };

      var koResults = {};
      for (var i = 0; i < koMatches.length; i++) {
        var km = koMatches[i];
        var hTeam = resolveRefToTeamIndex(km.homeRef, groupTables, koResults);
        var aTeam = resolveRefToTeamIndex(km.awayRef, groupTables, koResults);
        var s = scores[km.id];
        koResults[km.id] = {
          homeTeam: hTeam,
          awayTeam: aTeam,
          score_home: s && s.home !== '' ? parseInt(s.home, 10) : null,
          score_away: s && s.away !== '' ? parseInt(s.away, 10) : null
        };
      }

      renderSchedule(groupTables, koResults);
      renderKoInfo(groupTables, koResults);
      renderScorers();
    }

    /* ---------- Supabase Speichern / Laden ---------- */
    var supabaseSaveTimeout = null;
    function scheduleSupabaseSave() {
      if (!supabaseClient) return;
      if (supabaseSaveTimeout) window.clearTimeout(supabaseSaveTimeout);
      supabaseSaveTimeout = window.setTimeout(function () {
        saveToSupabase(false);
      }, 800);
    }

    async function loadFromSupabase() {
      if (!supabaseClient) return;
      try {
        var res = await supabaseClient
          .from("turnier_state")
          .select("data")
          .eq("id", TURNIER_STATE_ID)
          .maybeSingle();
        var data = res.data;
        var error = res.error;

        if (error) {
          console.warn("Fehler beim Laden aus Supabase:", error.message);
          setSupabaseStatus(false, "Supabase erreichbar, aber Tabelle/Datensatz fehlt (lokale Daten aktiv)");
          return;
        }

        if (data && data.data && data.data.teams) {
          teams = data.data.teams;
          scores = data.data.scores || {};
          scorers = data.data.scorers || JSON.parse(JSON.stringify(defaultScorers));
          saveToLocal();
          setSupabaseStatus(true, "Supabase online ‚Äì Turnierstand geladen");
        } else {
          await saveToSupabase(true);
        }
      } catch (e) {
        console.warn("Supabase-Load Exception:", e);
        setSupabaseStatus(false, "Supabase nicht erreichbar ‚Äì lokale Daten aktiv");
      }
    }

    async function saveToSupabase(isInitial) {
      if (!supabaseClient) return;
      try {
        var payload = { id: TURNIER_STATE_ID, data: { teams: teams, scores: scores, scorers: scorers } };
        var res = await supabaseClient
          .from("turnier_state")
          .upsert(payload);
        var error = res.error;
        if (error) {
          console.warn("Fehler beim Speichern in Supabase:", error.message);
          setSupabaseStatus(false, "Supabase-Fehler beim Speichern (Pruefe Tabelle turnier_state)");
          return;
        }
        setSupabaseStatus(true, isInitial ? "Supabase online ‚Äì Standarddaten angelegt" : "Supabase online ‚Äì Daten gespeichert");
      } catch (e) {
        console.warn("Supabase-Save Exception:", e);
        setSupabaseStatus(false, "Supabase nicht erreichbar beim Speichern");
      }
    }

    /* ---------- Trainer-Login & Editierbarkeit ---------- */
    function updateEditability() {
      var inputs = document.querySelectorAll(
        '.team-name-input, .players-textarea, .score-input, .scorer-name-input, .scorer-goals-input'
      );
      for (var i = 0; i < inputs.length; i++) {
        inputs[i].disabled = !isTrainer;
        if (!isTrainer) inputs[i].classList.add('readonly');
        else inputs[i].classList.remove('readonly');
      }

      var modePill = document.getElementById('modePill');
      var modeLabel = document.getElementById('modeLabel');
      var loginBtn = document.getElementById('loginBtn');
      var logoutBtn = document.getElementById('logoutBtn');

      if (isTrainer) {
        modePill.classList.add('trainer');
        modeLabel.textContent = "Modus: Trainer (Bearbeiten aktiviert)";
        loginBtn.style.display = 'inline-flex';
        loginBtn.textContent = 'Trainer-Login';
        loginBtn.disabled = true;
        loginBtn.style.opacity = 0.4;
        logoutBtn.style.display = 'inline-flex';
      } else {
        modePill.classList.remove('trainer');
        modeLabel.textContent = "Modus: Zuschauer (nur lesen)";
        loginBtn.style.display = 'inline-flex';
        loginBtn.textContent = 'Trainer-Login';
        loginBtn.disabled = false;
        loginBtn.style.opacity = 1;
        logoutBtn.style.display = 'none';
      }
    }

    function initTrainerLogin() {
      var loginBtn = document.getElementById('loginBtn');
      var logoutBtn = document.getElementById('logoutBtn');

      var saved = null;
      try {
        saved = localStorage.getItem(TRAINER_MODE_KEY);
      } catch (e) {}
      if (saved === '1') {
        isTrainer = true;
      }
      updateEditability();

      if (loginBtn) {
        loginBtn.addEventListener('click', function () {
          var pw = window.prompt("Trainer-Passwort eingeben:");
          if (pw === null) return;
          if (pw === TRAINER_PASSWORD) {
            isTrainer = true;
            try {
              localStorage.setItem(TRAINER_MODE_KEY, '1');
            } catch (e) {}
            updateEditability();
          } else {
            alert("Falsches Passwort.");
          }
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', function () {
          isTrainer = false;
          try {
            localStorage.removeItem(TRAINER_MODE_KEY);
          } catch (e) {}
          updateEditability();
        });
      }
    }

    /* ---------- Tabs ---------- */
    function initTabs() {
      var buttons = document.querySelectorAll('.tab-btn');
      for (var i = 0; i < buttons.length; i++) {
        (function (btn) {
          btn.addEventListener('click', function () {
            var page = btn.getAttribute('data-page');
            for (var j = 0; j < buttons.length; j++) {
              buttons[j].classList.toggle('active', buttons[j] === btn);
            }
            var pages = document.querySelectorAll('.page');
            for (j = 0; j < pages.length; j++) {
              pages[j].classList.toggle('active', pages[j].id === 'page-' + page);
            }
            if (page === 'fotos') {
              loadPhotos();
            }
          });
        })(buttons[i]);
      }
    }

    /* ---------- Fotos via Supabase Storage ---------- */
    async function loadPhotos() {
      var gallery = document.getElementById('photoGallery');
      if (!gallery) return;
      gallery.innerHTML = '';

      if (!supabaseClient) {
        var msg = document.createElement('div');
        msg.className = 'hint';
        msg.textContent = 'Supabase ist nicht verfuegbar. Foto-Upload deaktiviert.';
        gallery.appendChild(msg);
        return;
      }

      try {
        var res = await supabaseClient
          .storage
          .from('photos')
          .list('hcw-u10', { limit: 100, sortBy: { column: 'name', order: 'desc' } });
        var data = res.data;
        var error = res.error;
        if (error) {
          console.warn('Fehler beim Laden der Fotos:', error.message);
          var msg2 = document.createElement('div');
          msg2.className = 'hint';
          msg2.textContent = 'Fehler: ' + error.message + ' (Bucket "photos" und Ordner "hcw-u10" vorhanden?).';
          gallery.appendChild(msg2);
          return;
        }

        if (!data || data.length === 0) {
          var msg3 = document.createElement('div');
          msg3.className = 'hint';
          msg3.textContent = 'Noch keine Fotos hochgeladen.';
          gallery.appendChild(msg3);
          return;
        }

        for (var i = 0; i < data.length; i++) {
          (function (file) {
            var pub = supabaseClient
              .storage
              .from('photos')
              .getPublicUrl('hcw-u10/' + file.name);
            var url = pub.data.publicUrl;

            var item = document.createElement('div');
            item.className = 'photo-item';

            var img = document.createElement('img');
            img.src = url;
            img.alt = file.name;

            var link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.textContent = 'Download / Oeffnen';

            item.appendChild(img);
            item.appendChild(link);

            if (isTrainer) {
              var delBtn = document.createElement('button');
              delBtn.className = 'photo-delete-btn';
              delBtn.textContent = '‚úï';
              delBtn.title = 'Foto loeschen (Trainer)';
              delBtn.addEventListener('click', function () {
                if (confirm('Foto wirklich loeschen?')) {
                  deletePhoto('hcw-u10/' + file.name);
                }
              });
              item.appendChild(delBtn);
            }

            gallery.appendChild(item);
          })(data[i]);
        }
      } catch (e) {
        console.warn('Exception beim Laden der Fotos:', e);
        var msg4 = document.createElement('div');
        msg4.className = 'hint';
        msg4.textContent = 'Fehler beim Laden der Fotos. Details in der Browser-Konsole.';
        gallery.appendChild(msg4);
      }
    }

    async function deletePhoto(path) {
      if (!isTrainer) return;
      if (!supabaseClient) return;
      try {
        var res = await supabaseClient
          .storage
          .from('photos')
          .remove([path]);
        var error = res.error;
        if (error) {
          alert('Fehler beim Loeschen des Fotos: ' + error.message);
        }
      } catch (e) {
        alert('Exception beim Loeschen des Fotos. Details in der Konsole.');
      }
      loadPhotos();
    }

    async function uploadPhotos(files) {
      if (!supabaseClient) {
        alert("Supabase ist nicht verfuegbar. Foto-Upload nicht moeglich.");
        return;
      }
      if (!files || files.length === 0) return;

      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        var timestamp = Date.now();
        var safeName = file.name.replace(/[^a-z0-9.\-_]/gi, "_");
        var filePath = 'hcw-u10/' + timestamp + '_' + safeName;
        try {
          var res = await supabaseClient
            .storage
            .from('photos')
            .upload(filePath, file);
          var error = res.error;
          if (error) {
            alert('Upload-Fehler fuer ' + file.name + ': ' + error.message +
                  '\nPruefe Bucket "photos" (Public) und Ordner "hcw-u10".');
          }
        } catch (e) {
          alert('Upload-Exception fuer ' + file.name + '. Details in der Konsole.');
        }
      }
      loadPhotos();
    }

    function initPhotoUpload() {
      var input = document.getElementById('photoInput');
      if (!input) return;
      input.addEventListener('change', function () {
        var files = Array.prototype.slice.call(input.files || []);
        if (files.length > 0) {
          uploadPhotos(files);
        }
      });
    }

    /* ---------- Init ---------- */
    (function init() {
      loadFromLocal();
      renderTeams();
      recomputeAndRender();
      initTabs();
      initPhotoUpload();
      initTrainerLogin();

      if (supabaseClient) {
        loadFromSupabase().then(function () {
          renderTeams();
          recomputeAndRender();
        });
      }
    })();
  </script>
</body>
</html>

